<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸƒ Truco!</title>
<style>
:root {
  --felt: #1a472a;
  --gold: #c9a94a;
  --gold2: #f0d060;
  --red: #c0392b;
  --bg: #0d2318;
  --cw: 58px;
  --ch: 86px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  background: var(--bg);
  min-height: 100svh;
  font-family: Georgia, 'Times New Roman', serif;
  color: #f0e6c8;
  background-image:
    radial-gradient(ellipse 70% 50% at 20% 10%, rgba(26,80,45,0.7) 0%, transparent 60%),
    radial-gradient(ellipse 60% 60% at 85% 90%, rgba(15,55,30,0.8) 0%, transparent 60%),
    repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(255,255,255,.012) 3px,rgba(255,255,255,.012) 6px);
}

/* â”€â”€ SETUP â”€â”€ */
.setup {
  display:flex; align-items:center; justify-content:center;
  min-height:100svh; padding:20px;
}
.setup-box {
  background:rgba(255,255,255,.05);
  border:1px solid rgba(201,169,74,.3);
  border-radius:20px; padding:36px 28px;
  max-width:360px; width:100%; text-align:center;
  box-shadow:0 0 80px rgba(0,0,0,.6), inset 0 1px 0 rgba(201,169,74,.18);
  backdrop-filter:blur(8px);
}
.setup-icon { font-size:54px; display:block; margin-bottom:10px; filter:drop-shadow(0 4px 12px rgba(0,0,0,.5)); }
.setup-h1 { font-size:38px; color:var(--gold); letter-spacing:6px; text-transform:uppercase; text-shadow:0 0 30px rgba(201,169,74,.3); }
.setup-sub { font-size:12px; color:rgba(240,230,200,.5); font-style:italic; letter-spacing:1.5px; margin:4px 0 28px; }
.lbl { font-size:10px; color:var(--gold); letter-spacing:2px; text-transform:uppercase; display:block; text-align:left; margin-bottom:5px; }
.inp {
  width:100%; padding:11px 14px; background:rgba(255,255,255,.07);
  border:1px solid rgba(201,169,74,.22); border-radius:8px;
  color:#f0e6c8; font-size:15px; font-family:Georgia,serif;
  outline:none; transition:border-color .2s; margin-bottom:14px;
}
.inp:focus { border-color:var(--gold); background:rgba(255,255,255,.1); }
.inp::placeholder { color:rgba(240,230,200,.25); }
.btn-start {
  width:100%; margin-top:4px; padding:14px;
  background:linear-gradient(135deg,#a0762a,#d4af37,#a87830);
  color:#1a0e00; border:none; border-radius:10px;
  font-size:16px; font-weight:bold; font-family:Georgia,serif;
  letter-spacing:2px; text-transform:uppercase; cursor:pointer;
  box-shadow:0 4px 20px rgba(201,169,74,.25); transition:all .2s;
}
.btn-start:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(201,169,74,.35); }

/* â”€â”€ GAME â”€â”€ */
.game {
  padding:10px; max-width:480px; margin:0 auto;
  min-height:100svh; display:flex; flex-direction:column; gap:8px;
  padding-bottom:20px;
}

/* Header */
.hdr {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px;
  background:rgba(0,0,0,.35); border-radius:12px;
  border:1px solid rgba(201,169,74,.18);
}
.hdr-title { font-size:18px; color:var(--gold); letter-spacing:4px; font-weight:bold; }
.hdr-hand  { font-size:10px; color:rgba(240,230,200,.5); font-style:italic; letter-spacing:1px; margin-top:2px; }
.score-n   { font-size:22px; font-weight:bold; color:var(--gold); line-height:1; text-align:right; }
.score-lbl { font-size:10px; color:rgba(240,230,200,.4); letter-spacing:.5px; }

/* Panel */
.panel {
  padding:10px 12px;
  background:rgba(0,0,0,.22); border-radius:10px;
  border:1px solid rgba(255,255,255,.06);
}
.panel-lbl {
  font-size:9px; color:rgba(240,230,200,.45);
  letter-spacing:2px; text-transform:uppercase; margin-bottom:7px;
}
.you-tag {
  background:rgba(201,169,74,.18); color:var(--gold);
  border:1px solid rgba(201,169,74,.28); border-radius:4px;
  padding:1px 6px; font-size:8px; margin-left:6px;
}

/* Vira bar */
.vira-bar {
  display:flex; align-items:center; gap:10px;
  padding:8px 12px;
  background:rgba(0,0,0,.2); border-radius:10px;
  border:1px solid rgba(201,169,74,.12);
}
.vira-lbl { font-size:9px; color:var(--gold); letter-spacing:2px; text-transform:uppercase; }
.manilha-pill {
  margin-left:auto; background:rgba(201,169,74,.12);
  border:1px solid rgba(201,169,74,.35); border-radius:6px;
  padding:3px 10px; font-size:12px; color:var(--gold2);
}

/* Cards */
.cards-row { display:flex; gap:8px; align-items:flex-end; }
.card {
  width:var(--cw); height:var(--ch);
  border-radius:8px; flex-shrink:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  transition:transform .18s, box-shadow .18s;
  box-shadow:2px 4px 10px rgba(0,0,0,.45);
  position:relative; user-select:none;
}
.face-up  { background:#fefefe; border:1px solid #e0d8c8; }
.face-down {
  background:linear-gradient(135deg,#1b5e38,#2a7a4e,#1b5e38);
  border:2px solid rgba(201,169,74,.45);
}
.face-down::after { content:'ğŸ‚ '; font-size:26px; filter:drop-shadow(0 0 6px rgba(201,169,74,.4)); }
.card.empty-slot {
  border:1px dashed rgba(255,255,255,.13); background:transparent;
  box-shadow:none; opacity:.35;
}
.card.selectable { cursor:pointer; }
.card.selectable:hover { transform:translateY(-7px); box-shadow:0 10px 22px rgba(0,0,0,.5); }
.card.sel { transform:translateY(-14px) !important; box-shadow:0 14px 28px rgba(201,169,74,.45) !important; border:2px solid var(--gold) !important; }
.cv { font-size:18px; font-weight:bold; line-height:1; }
.cs { font-size:20px; line-height:1.1; }
.rd { color:var(--red); }
.bk { color:#1a1a2e; }

/* Rounds */
.round-row { display:flex; align-items:center; gap:6px; margin-bottom:5px; font-size:11px; }
.rlbl { width:60px; flex-shrink:0; color:rgba(240,230,200,.4); letter-spacing:1px; font-size:10px; }
.vs { color:rgba(240,230,200,.25); font-size:10px; }
.rwinner { margin-left:auto; font-size:11px; white-space:nowrap; }
.won  { color:#68d391; }
.lost { color:#fc8181; }
.drw  { color:rgba(240,230,200,.45); }

/* Buttons */
.btn-row { display:flex; gap:8px; }
.btn {
  flex:1; padding:12px 10px; border:none; border-radius:9px;
  font-size:14px; font-family:Georgia,serif; font-weight:bold;
  cursor:pointer; letter-spacing:1px; transition:all .15s;
}
.btn:active { transform:scale(.96); }
.b-play { background:linear-gradient(135deg,#1e5a36,#27ae60); color:#fff; }
.b-play:disabled { background:#3a4a3d; color:rgba(255,255,255,.3); cursor:not-allowed; }
.b-truco { background:linear-gradient(135deg,#6b2500,#e67e22); color:#fff; }
.b-acc   { background:linear-gradient(135deg,#155724,#28a745); color:#fff; }
.b-ref   { background:linear-gradient(135deg,#6b1414,#dc3545); color:#fff; }
.b-raise { background:linear-gradient(135deg,#6b4000,#fd7e14); color:#fff; }
.b-next  { background:linear-gradient(135deg,#1a3d6b,#3498db); color:#fff; width:100%; }
.b-restart { background:linear-gradient(135deg,#3d1a00,#a0522d); color:#fff; width:100%; }

/* Info boxes */
.wait-box {
  padding:12px; border-radius:9px; text-align:center; font-size:13px;
  background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.07);
  color:rgba(240,230,200,.65); font-style:italic;
}
.truco-wrap {
  padding:14px; border-radius:10px;
  background:rgba(230,126,34,.12); border:1px solid rgba(230,126,34,.38);
}
.truco-h { font-size:20px; font-weight:bold; color:#f0932b; text-align:center; letter-spacing:3px; margin-bottom:10px; }
.end-wrap { padding:16px; border-radius:10px; background:rgba(0,0,0,.32); border:1px solid rgba(201,169,74,.28); text-align:center; }
.end-h { font-size:20px; color:var(--gold); font-weight:bold; margin-bottom:5px; }
.end-sub { font-size:13px; color:rgba(240,230,200,.55); margin-bottom:12px; }
.turn-tip { text-align:center; font-size:11px; color:var(--gold); letter-spacing:1px; font-style:italic; padding:4px 0; }

/* Share */
.share-box {
  padding:12px 14px; border-radius:10px;
  background:rgba(0,0,0,.32); border:1px solid rgba(37,211,102,.28);
}
.share-lbl { font-size:11px; color:rgba(240,230,200,.7); margin-bottom:8px; letter-spacing:.5px; }
.share-row { display:flex; gap:6px; margin-bottom:8px; }
.share-url {
  flex:1; padding:8px 10px; background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.09); border-radius:6px;
  color:rgba(240,230,200,.65); font-size:11px; outline:none;
  overflow:hidden; white-space:nowrap;
}
.b-copy {
  padding:8px 12px; background:#2b6cb0; color:#fff;
  border:none; border-radius:6px; font-size:12px; cursor:pointer;
  font-family:Georgia,serif; font-weight:bold; white-space:nowrap; transition:background .2s;
}
.b-copy.ok { background:#276749; }
.b-wa {
  display:block; width:100%; padding:10px;
  background:#25d366; color:#fff; text-decoration:none;
  border-radius:7px; text-align:center; font-weight:bold;
  font-size:14px; font-family:Georgia,serif; letter-spacing:1px;
}

hr.divider { border:none; border-top:1px solid rgba(255,255,255,.06); margin:2px 0; }
</style>
</head>
<body>
<div id="root"></div>
<script>
'use strict';

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUITS  = ['â™ ','â™¥','â™¦','â™£'];
const VALUES = ['4','5','6','7','Q','J','K','A','2','3'];
const TVALS  = [1,3,6,9,12];
const TLBL   = ['','Truco!','Seis!','Nove!','Doze!'];
const MR     = {'â™£':14,'â™¥':13,'â™ ':12,'â™¦':11}; // manilha suit rank

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function manilhaOf(viraV) { return VALUES[(VALUES.indexOf(viraV)+1)%VALUES.length]; }

function power(card, mn) {
  if (!card) return -1;
  return card.v===mn ? MR[card.s] : VALUES.indexOf(card.v);
}

function seeded(seed) {
  let s=seed>>>0;
  return ()=>{ s=(Math.imul(1664525,s)+1013904223)>>>0; return s/4294967296; };
}

function shuffle(seed) {
  const d=SUITS.flatMap(s=>VALUES.map(v=>({v,s})));
  const r=seeded(seed);
  for(let i=d.length-1;i>0;i--){ const j=Math.floor(r()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
  return d;
}

function deal(seed) {
  const d=shuffle(seed);
  return {p1:d.slice(0,3), p2:d.slice(3,6), vira:d[6]};
}

function roundW(c1,c2,mn) {
  const a=power(c1,mn), b=power(c2,mn);
  return a>b?1:b>a?2:0;
}

function handW(rounds) {
  const n=rounds.length; if(!n) return null;
  const w=[0,0,0]; for(const r of rounds) w[r.w]++;
  if(w[1]>=2) return 1;
  if(w[2]>=2) return 2;
  if(n>=2){
    const a=rounds[0].w, b=rounds[1].w;
    if(a===0&&b===0) return null;          // both draw â†’ round 3
    if(a===0&&b!==0) return b;             // draw + win
    if(a!==0&&b===0) return a;             // win + draw
    if(a!==0&&b!==0&&a!==b) return null;  // split â†’ round 3
  }
  if(n===3){
    if(w[0]===3) return 0;
    for(const r of rounds) if(r.w!==0) return r.w;
    return 0;
  }
  return null;
}

function enc(s) { try{return btoa(unescape(encodeURIComponent(JSON.stringify(s))))}catch(e){return btoa(JSON.stringify(s))} }
function dec(b) { try{return JSON.parse(decodeURIComponent(escape(atob(b))))}catch(e){return JSON.parse(atob(b))} }

function makeUrl(gs,p) {
  return location.href.split('#')[0]+'#g='+enc(gs)+'&p='+p;
}

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let GS=null, ME=null, SEL=null, LINK='', COPIED=false;

function loadHash() {
  const h=location.hash.slice(1); if(!h) return false;
  try{
    const p=new URLSearchParams(h);
    const g=p.get('g'), pv=p.get('p');
    if(g&&pv){ GS=dec(g); ME=+pv; return true; }
  }catch(e){}
  return false;
}

function commit(ng) {
  GS=ng; SEL=null; COPIED=false;
  const other=ME===1?2:1;
  LINK=makeUrl(ng,other);
  history.replaceState(null,'',makeUrl(ng,ME));
  render();
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(n1,n2) {
  const seed=(Math.random()*999998+1)|0;
  const {p1,p2,vira}=deal(seed);
  const gs={
    names:[n1||'Jogador 1', n2||'Jogador 2'],
    scores:[0,0], vira, p1Cards:p1, p2Cards:p2,
    rounds:[], cur:{p1:null,p2:null},
    turn:1, firstPlay:1,
    truco:{st:'none',by:null,vi:0,tb:1},
    phase:'play', hw:null, seed,
  };
  GS=gs; ME=1; SEL=null; COPIED=false;
  LINK=makeUrl(gs,2);
  history.replaceState(null,'',makeUrl(gs,1));
  render();
}

function playCard(idx) {
  if(!GS||GS.phase!=='play'||GS.turn!==ME) return;
  const key=ME===1?'p1Cards':'p2Cards';
  const card=GS[key][idx]; if(!card) return;

  const ng=JSON.parse(JSON.stringify(GS));
  ng[key][idx]=null;
  ng.cur[ME===1?'p1':'p2']=card;

  if(ng.cur.p1&&ng.cur.p2){
    const mn=manilhaOf(ng.vira.v);
    const w=roundW(ng.cur.p1,ng.cur.p2,mn);
    ng.rounds.push({p1:ng.cur.p1,p2:ng.cur.p2,w});
    ng.cur={p1:null,p2:null};
    const hw=handW(ng.rounds);
    if(hw!==null){
      ng.phase='handEnd'; ng.hw=hw;
      const pts=TVALS[ng.truco.vi];
      if(hw===0){ng.scores[0]+=1;ng.scores[1]+=1;}
      else ng.scores[hw-1]+=pts;
      if(ng.scores[0]>=12||ng.scores[1]>=12) ng.phase='gameOver';
    } else {
      const lw=ng.rounds[ng.rounds.length-1].w;
      ng.turn=lw===0?ng.firstPlay:lw;
    }
  } else {
    ng.turn=ME===1?2:1;
  }
  commit(ng);
}

function callTruco() {
  if(!GS||GS.phase!=='play') return;
  const nvi=GS.truco.st==='none'?1:GS.truco.vi+1;
  if(nvi>=TVALS.length) return;
  const ng=JSON.parse(JSON.stringify(GS));
  ng.truco={st:'pending',by:ME,vi:nvi,tb:GS.turn};
  ng.phase='trucoAsk';
  commit(ng);
}

function respondTruco(r) {
  if(!GS||GS.phase!=='trucoAsk'||GS.truco.by===ME) return;
  const ng=JSON.parse(JSON.stringify(GS));
  if(r==='acc'){
    ng.truco.st='accepted'; ng.phase='play'; ng.turn=ng.truco.tb;
  } else if(r==='ref'){
    const pts=TVALS[ng.truco.vi-1]||1;
    ng.scores[ng.truco.by-1]+=pts;
    ng.hw=ng.truco.by;
    ng.phase=ng.scores[0]>=12||ng.scores[1]>=12?'gameOver':'handEnd';
  } else if(r==='raise'){
    const nvi=ng.truco.vi+1;
    if(nvi<TVALS.length) ng.truco={st:'pending',by:ME,vi:nvi,tb:ng.truco.tb};
  }
  commit(ng);
}

function nextHand() {
  if(!GS) return;
  // Only the "dealer" (alternates each hand) can start â€” winner of previous hand starts next
  const seed=(Math.random()*999998+1)|0;
  const {p1,p2,vira}=deal(seed);
  const nfp=GS.firstPlay===1?2:1;
  const ng={
    ...GS, vira, p1Cards:p1, p2Cards:p2,
    rounds:[], cur:{p1:null,p2:null},
    turn:nfp, firstPlay:nfp,
    truco:{st:'none',by:null,vi:0,tb:nfp},
    phase:'play', hw:null, seed,
  };
  commit(ng);
}

function restartGame() {
  GS=null; ME=null; SEL=null; LINK=''; COPIED=false;
  history.replaceState(null,'',location.href.split('#')[0]);
  render();
}

function copyLink() {
  const doCopy=()=>{ COPIED=true; render(); setTimeout(()=>{COPIED=false;render();},2500); };
  navigator.clipboard.writeText(LINK).then(doCopy).catch(()=>{
    const ta=document.createElement('textarea');
    ta.value=LINK; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta); doCopy();
  });
}

// â”€â”€â”€ Card HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cardH(card, sel=false, selectable=false, empty=false) {
  if(empty) return `<div class="card empty-slot"></div>`;
  if(!card) return `<div class="card face-down"></div>`; // hidden back
  const red=card.s==='â™¥'||card.s==='â™¦';
  const col=red?'rd':'bk';
  let cls='card face-up';
  if(sel) cls+=' sel';
  if(selectable) cls+=' selectable';
  return `<div class="${cls}"><div class="cv ${col}">${card.v}</div><div class="cs ${col}">${card.s}</div></div>`;
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  document.getElementById('root').innerHTML = GS ? renderGame() : renderSetup();
  attachEvents();
}

function renderSetup() {
  return `<div class="setup"><div class="setup-box">
    <span class="setup-icon">ğŸƒ</span>
    <div class="setup-h1">Truco!</div>
    <div class="setup-sub">Jogue via WhatsApp Â· 2 jogadores</div>
    <label class="lbl">Seu nome (Jogador 1)</label>
    <input class="inp" id="in1" placeholder="Ex: JoÃ£o" autocomplete="off">
    <label class="lbl">Nome do amigo (Jogador 2)</label>
    <input class="inp" id="in2" placeholder="Ex: Maria" autocomplete="off">
    <button class="btn-start" id="btnStart">Criar Partida â†—</button>
  </div></div>`;
}

function renderGame() {
  const gs=GS, me=ME, opp=me===1?2:1;
  const myName=gs.names[me-1], oppName=gs.names[opp-1];
  const myScore=gs.scores[me-1], oppScore=gs.scores[opp-1];
  const myCards=me===1?gs.p1Cards:gs.p2Cards;
  const oppCards=me===1?gs.p2Cards:gs.p1Cards;
  const mn=manilhaOf(gs.vira.v);
  const itsMeTurn=gs.turn===me;
  const tval=TVALS[gs.truco.vi];
  const pts=tval===1?'1 ponto':`${tval} pontos`;

  let h=`<div class="game">`;

  // Header
  h+=`<div class="hdr">
    <div><div class="hdr-title">ğŸƒ TRUCO</div><div class="hdr-hand">MÃ£o vale ${pts}</div></div>
    <div><div class="score-n">${myScore} <span style="opacity:.35">Ã—</span> ${oppScore}</div>
    <div class="score-lbl">${myName} &nbsp;Ã—&nbsp; ${oppName}</div></div>
  </div>`;

  // Vira
  h+=`<div class="vira-bar">
    <div><div class="vira-lbl">Vira</div>${cardH(gs.vira)}</div>
    <div class="manilha-pill">Manilha: <strong>${mn}</strong></div>
  </div>`;

  // Opponent cards
  h+=`<div class="panel">
    <div class="panel-lbl">${oppName}</div>
    <div class="cards-row">
      ${oppCards.map(c=>c?cardH(null):cardH(null,false,false,true)).join('')}
    </div>
  </div>`;

  // Rounds
  const showRounds=gs.rounds.length>0||gs.cur.p1||gs.cur.p2;
  if(showRounds){
    h+=`<div class="panel">`;
    gs.rounds.forEach((r,i)=>{
      const mc=me===1?r.p1:r.p2, oc=me===1?r.p2:r.p1;
      let wlbl='';
      if(r.w===0)     wlbl=`<span class="drw">â€” Empate</span>`;
      else if(r.w===me) wlbl=`<span class="won">âœ“ VocÃª</span>`;
      else             wlbl=`<span class="lost">âœ“ ${oppName}</span>`;
      h+=`<div class="round-row">
        <span class="rlbl">Rod. ${i+1}</span>
        ${cardH(mc)}<span class="vs">vs</span>${cardH(oc)}
        <div class="rwinner">${wlbl}</div>
      </div>`;
    });
    if(gs.cur.p1||gs.cur.p2){
      const mc=me===1?gs.cur.p1:gs.cur.p2, oc=me===1?gs.cur.p2:gs.cur.p1;
      h+=`<div class="round-row">
        <span class="rlbl">Rod. ${gs.rounds.length+1}</span>
        ${mc?cardH(mc):cardH(null,false,false,true)}
        <span class="vs">vs</span>
        ${oc?cardH(oc):cardH(null,false,false,true)}
      </div>`;
    }
    h+=`</div>`;
  }

  // My cards
  const canSel=gs.phase==='play'&&itsMeTurn;
  h+=`<div class="panel">
    <div class="panel-lbl">${myName}<span class="you-tag">VOCÃŠ</span></div>
    <div class="cards-row">
      ${myCards.map((c,i)=>c
        ? `<div data-ci="${i}">${cardH(c,SEL===i,canSel)}</div>`
        : cardH(null,false,false,true)
      ).join('')}
    </div>
  </div>`;

  // Actions
  h+=`<div style="display:flex;flex-direction:column;gap:8px">`;

  if(gs.phase==='play'){
    if(itsMeTurn){
      h+=`<div class="turn-indicator" style="text-align:center;font-size:11px;color:var(--gold);letter-spacing:1px;font-style:italic;padding:2px 0">
        âœ¦ Sua vez â€” toque em uma carta para selecionar
      </div>`;
      const canT=gs.truco.vi<4&&(gs.truco.st==='none'||(gs.truco.st==='accepted'&&gs.truco.vi<4));
      const tlbl=gs.truco.st==='none'?'Truco!':TLBL[gs.truco.vi+1]||'Doze!';
      h+=`<div class="btn-row">
        <button class="btn b-play" id="btnPlay" ${SEL===null?'disabled':''}
          style="${SEL===null?'':'box-shadow:0 0 18px rgba(46,204,113,.3)'}">
          Jogar carta
        </button>
        ${canT?`<button class="btn b-truco" id="btnTruco">${tlbl}</button>`:''}
      </div>`;
    } else {
      h+=`<div class="wait-box">â³ Aguardando <strong>${oppName}</strong> jogar...</div>`;
    }
  }

  if(gs.phase==='trucoAsk'){
    h+=`<div class="truco-wrap">`;
    if(gs.truco.by===me){
      h+=`<div class="truco-h">${TLBL[gs.truco.vi]}</div>
          <div class="wait-box" style="background:transparent;border:none">Aguardando <strong>${oppName}</strong> responder...</div>`;
    } else {
      h+=`<div class="truco-h">${oppName} pediu ${TLBL[gs.truco.vi]}</div>
          <div class="btn-row" style="flex-wrap:wrap;gap:6px">
            <button class="btn b-acc" id="btnAcc">âœ“ Aceitar (${TVALS[gs.truco.vi]} pts)</button>
            <button class="btn b-ref" id="btnRef">âœ— Correr (${TVALS[gs.truco.vi-1]||1}pt p/ ${oppName})</button>
            ${gs.truco.vi<4?`<button class="btn b-raise" id="btnRaise" style="flex:1 0 100%">${TLBL[gs.truco.vi+1]||'Doze!'} (contra-truco)</button>`:''}
          </div>`;
    }
    h+=`</div>`;
  }

  if(gs.phase==='handEnd'){
    let title='';
    if(gs.hw===0)    title=`ğŸ¤ Empate! (+1 cada)`;
    else if(gs.hw===me) title=`âœ“ VocÃª venceu a mÃ£o! (+${TVALS[gs.truco.vi]})`;
    else                title=`${oppName} venceu a mÃ£o (+${TVALS[gs.truco.vi]})`;
    h+=`<div class="end-wrap">
      <div class="end-h">${title}</div>
      <div class="end-sub">Placar: ${myScore} Ã— ${oppScore}</div>
      <button class="btn b-next" id="btnNext">PrÃ³xima mÃ£o â†’</button>
    </div>`;
  }

  if(gs.phase==='gameOver'){
    const iWon=gs.scores[me-1]>=12;
    h+=`<div class="end-wrap">
      <div style="font-size:40px;margin-bottom:8px">${iWon?'ğŸ†':'ğŸ‘'}</div>
      <div class="end-h" style="color:${iWon?'var(--gold)':'#fc8181'}">${iWon?'VocÃª venceu o jogo!':oppName+' venceu o jogo!'}</div>
      <div class="end-sub">Placar final: ${gs.scores[me-1]} Ã— ${gs.scores[opp-1]}</div>
      <button class="btn b-restart" id="btnRestart">ğŸ”„ Nova partida</button>
    </div>`;
  }

  h+=`</div>`; // actions

  // Share section
  if(LINK){
    const needShare =
      (gs.phase==='play' && !itsMeTurn) ||
      (gs.phase==='trucoAsk' && gs.truco.by===me) ||
      gs.phase==='handEnd' ||
      (gs.phase==='play' && gs.rounds.length===0 && !gs.cur.p1 && !gs.cur.p2 && me===1 && gs.truco.st==='none');

    if(needShare){
      let lbl=`ğŸ“± Envie para <strong>${oppName}</strong> jogar:`;
      if(gs.phase==='handEnd') lbl=`ğŸ“± Envie para <strong>${oppName}</strong> ver o resultado:`;
      if(gs.rounds.length===0&&me===1) lbl=`ğŸ“± Convide <strong>${oppName}</strong> para entrar na partida:`;

      const waMsg=encodeURIComponent(`${me===1&&gs.rounds.length===0?'Vamos jogar Truco! ğŸƒ Clique para entrar na partida':'Sua vez no Truco! ğŸƒ'}
${LINK}`);

      h+=`<div class="share-box">
        <div class="share-lbl">${lbl}</div>
        <div class="share-row">
          <input class="share-url" type="text" readonly value="${LINK}" id="shareUrl">
          <button class="b-copy ${COPIED?'ok':''}" id="btnCopy">${COPIED?'âœ“ Copiado!':'Copiar'}</button>
        </div>
        <a class="b-wa" href="https://wa.me/?text=${waMsg}" target="_blank" rel="noopener">
          ğŸ“± Enviar no WhatsApp
        </a>
      </div>`;
    }
  }

  h+=`</div>`; // game
  return h;
}

// â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function attachEvents() {
  const q=id=>document.getElementById(id);
  const on=(id,fn)=>{ const el=q(id); if(el) el.addEventListener('click',fn); };

  if(!GS){
    on('btnStart',()=>{ startGame(q('in1').value.trim(), q('in2').value.trim()); });
    ['in1','in2'].forEach(id=>{
      const el=q(id); if(el) el.addEventListener('keydown',e=>{ if(e.key==='Enter') q('btnStart').click(); });
    });
    return;
  }

  // Card selection
  document.querySelectorAll('[data-ci]').forEach(el=>{
    el.addEventListener('click',()=>{
      if(GS.phase!=='play'||GS.turn!==ME) return;
      const i=+el.getAttribute('data-ci');
      SEL=SEL===i?null:i; render();
    });
  });

  on('btnPlay', ()=>{ if(SEL!==null) playCard(SEL); });
  on('btnTruco', callTruco);
  on('btnAcc',   ()=>respondTruco('acc'));
  on('btnRef',   ()=>respondTruco('ref'));
  on('btnRaise', ()=>respondTruco('raise'));
  on('btnNext',  nextHand);
  on('btnRestart', restartGame);
  on('btnCopy',  copyLink);
}

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadHash();
render();
window.addEventListener('hashchange',()=>{ if(loadHash()){SEL=null;LINK='';render();} });
</script>
</body>
</html>
